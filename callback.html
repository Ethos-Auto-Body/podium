<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Callback - E.A.B Developer Portal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        :root {
            --netlify-primary: #00ad9f;
            --netlify-primary-dark: #008e83;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        .loader {
            border-top-color: var(--netlify-primary);
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .btn-primary {
            background-color: var(--netlify-primary);
            border-color: var(--netlify-primary);
            color: white;
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background-color: var(--netlify-primary-dark);
            border-color: var(--netlify-primary-dark);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white shadow rounded-lg p-8 max-w-md w-full">
        <div id="loading" class="text-center">
            <svg class="animate-spin h-10 w-10 text-teal-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-medium text-gray-900">Processing authentication...</p>
            <p class="text-sm text-gray-500 mt-2">Please wait while we complete the OAuth process.</p>
        </div>
        
        <div id="success" class="text-center hidden">
            <div class="h-12 w-12 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-4">
                <svg class="h-6 w-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <p class="text-lg font-medium text-gray-900">Authentication successful!</p>
            <p class="text-sm text-gray-500 mt-2">You'll be redirected back to the application shortly.</p>
        </div>
        
        <div id="error" class="text-center hidden">
            <div class="h-12 w-12 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4">
                <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </div>
            <p class="text-lg font-medium text-gray-900">Authentication failed</p>
            <p id="error-message" class="text-sm text-gray-500 mt-2">There was an error processing your request.</p>
            <button id="return-btn" class="mt-4 btn-primary px-4 py-2 rounded-md text-sm font-medium">
                Return to application
            </button>
        </div>
    </div>

    <script>
        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }
        
        function showSuccess() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('success').classList.remove('hidden');
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            
            // Return button handler
            document.getElementById('return-btn').addEventListener('click', function() {
                window.location.href = '/';
            });
            
            if (!code || !state) {
                showError('Missing authorization code or state parameter.');
                return;
            }
            
            // Verify state to prevent CSRF
            const savedState = localStorage.getItem('eab_oauthState');
            if (!savedState || state !== JSON.parse(savedState)) {
                showError('Invalid state parameter. The request may have been tampered with.');
                return;
            }
            
            // Exchange the code for an access token
            const clientId = JSON.parse(localStorage.getItem('eab_clientId') || '""');
            const clientSecret = JSON.parse(localStorage.getItem('eab_clientSecret') || '""');
            const redirectUri = JSON.parse(localStorage.getItem('eab_redirectUri') || '""');
            
            if (!clientId || !clientSecret || !redirectUri) {
                showError('Missing OAuth credentials. Please go back and set up your OAuth settings.');
                return;
            }
            
            fetch('https://api.podium.com/oauth/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    client_id: clientId,
                    client_secret: clientSecret,
                    redirect_uri: redirectUri,
                    grant_type: 'authorization_code',
                    code: code
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error_description || data.error);
                }
                
                // Save the tokens
                localStorage.setItem('eab_accessToken', data.access_token);
                localStorage.setItem('eab_refreshToken', data.refresh_token);
                localStorage.setItem('eab_tokenExpiry', Date.now() + (data.expires_in * 1000));
                
                // Show success message and redirect
                showSuccess();
            })
            .catch(error => {
                showError('Failed to exchange authorization code: ' + error.message);
            });
        });
    </script>
</body>
</html>
