// Debug function for settings
function debugSettings() {
    console.log("Current settings:");
    console.log("Client ID:", localStorage.getItem('podium_client_id'));
    console.log("Redirect URI:", localStorage.getItem('podium_redirect_uri'));
    console.log("Refresh Interval:", localStorage.getItem('podium_refresh_interval'));
}

// OAuth Configuration Storage - REMOVED client_secret for security
const config = {
    clientId: localStorage.getItem('podium_client_id') || '',
    redirectUri: localStorage.getItem('podium_redirect_uri') || 'https://ethos-auto-body.github.io/podium/',
    refreshInterval: parseInt(localStorage.getItem('podium_refresh_interval') || '0', 10),
    apiBase: 'https://api.podium.com'
};

// Auth Token Storage
let auth = {
    accessToken: localStorage.getItem('podium_access_token') || null,
    refreshToken: localStorage.getItem('podium_refresh_token') || null,
    expiresAt: localStorage.getItem('podium_expires_at') || null
};

// DOM Elements container
const elements = {};

// Initialize DOM elements
function initializeElements() {
    elements.loginBtn = document.getElementById('login-btn');
    elements.logoutBtn = document.getElementById('logout-btn');
    elements.loggedOut = document.getElementById('logged-out');
    elements.loggedIn = document.getElementById('logged-in');
    elements.userInfo = document.getElementById('user-info');
    elements.authRequired = document.getElementById('auth-required');
    elements.mainContent = document.getElementById('main-content');
    elements.tabLinks = document.querySelectorAll('.tab-link');
    elements.tabPanes = document.querySelectorAll('.tab-pane');
    
    // Settings inputs - REMOVED client-secret for security
    elements.clientIdInput = document.getElementById('client-id');
    elements.redirectUriInput = document.getElementById('redirect-uri');
    elements.refreshIntervalSelect = document.getElementById('refresh-interval');
    elements.saveOAuthBtn = document.getElementById('save-oauth-settings');
    elements.saveAppSettingsBtn = document.getElementById('save-app-settings');
    
    // Campaign elements
    elements.newCampaignBtn = document.getElementById('new-campaign-btn');
    elements.campaignModal = document.getElementById('campaign-modal');
    elements.campaignForm = document.getElementById('campaign-form');
    elements.campaignTableBody = document.getElementById('campaigns-table-body');
    
    // Template elements
    elements.newTemplateBtn = document.getElementById('new-template-btn');
    elements.templateModal = document.getElementById('template-modal');
    elements.templateForm = document.getElementById('template-form');
    elements.templatesTableBody = document.getElementById('templates-table-body');
    
    // Contact elements
    elements.newContactBtn = document.getElementById('new-contact-btn');
    elements.contactModal = document.getElementById('contact-modal');
    elements.contactForm = document.getElementById('contact-form');
    elements.contactsTableBody = document.getElementById('contacts-table-body');
    
    console.log("DOM elements initialized");
}

// Initialize UI
function init() {
    console.log("Initializing application...");
    console.log("Current config:", config);
    
    // Load settings into form - REMOVED client-secret for security
    if (elements.clientIdInput) elements.clientIdInput.value = config.clientId || '';
    if (elements.redirectUriInput) elements.redirectUriInput.value = config.redirectUri || '';
    if (elements.refreshIntervalSelect) elements.refreshIntervalSelect.value = config.refreshInterval || 0;
    
    // Check for URL params (OAuth callback)
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    
    console.log("Authorization code in URL:", code);
    
    if (code) {
        console.log("Authorization code found, exchanging for token...");
        // Remove code from URL to prevent issues with refreshing
        window.history.replaceState({}, document.title, window.location.pathname);
        // Exchange code for token
        exchangeCodeForToken(code);
    } else {
        console.log("No authorization code found in URL");
        
        // Check if we have a valid token
        if (auth.accessToken && auth.expiresAt && new Date(auth.expiresAt) > new Date()) {
            console.log("Valid access token found, updating UI...");
            updateAuthUI(true);
            loadInitialData();
            
            // Check if there's a hash in the URL for direct navigation
            const hash = window.location.hash.replace('#', '');
            if (hash && ['dashboard', 'campaigns', 'templates', 'contacts', 'settings'].includes(hash)) {
                switchTab(hash);
            } else {
                // Switch to dashboard if authenticated
                switchTab('dashboard');
            }
        } else if (auth.refreshToken) {
            console.log("Access token expired, attempting to refresh...");
            refreshAccessToken();
        } else {
            console.log("No valid tokens found, showing unauthenticated UI");
            updateAuthUI(false);
            // If not authenticated, start on settings tab
            switchTab('settings');
        }
    }
    
    // Setup event listeners
    setupEventListeners();
    
    // Setup refresh interval if enabled
    if (config.refreshInterval > 0) {
        window.refreshIntervalId = setInterval(refreshData, config.refreshInterval);
    }
}

// Update UI based on auth state
function updateAuthUI(isLoggedIn) {
    console.log("Updating UI for auth state:", isLoggedIn);
    
    // Get elements directly if not in the elements object
    const loggedOut = elements.loggedOut || document.getElementById('logged-out');
    const loggedIn = elements.loggedIn || document.getElementById('logged-in');
    const authRequired = elements.authRequired || document.getElementById('auth-required');
    const userInfo = elements.userInfo || document.getElementById('user-info');
    
    if (!loggedOut || !loggedIn || !authRequired) {
        console.error("Auth UI elements not found");
        return;
    }
    
    if (isLoggedIn) {
        loggedOut.classList.add('hidden');
        loggedIn.classList.remove('hidden');
        authRequired.classList.add('hidden');
        
        // Update user info if available
        if (userInfo) {
            userInfo.textContent = 'Authenticated with Podium';
        }
        
        // Ensure dashboard tab is visible
        const dashboardTab = document.getElementById('dashboard-tab');
        const campaignsTab = document.getElementById('campaigns-tab');
        const templatesTab = document.getElementById('templates-tab');
        const contactsTab = document.getElementById('contacts-tab');
        
        if (dashboardTab) dashboardTab.classList.remove('hidden');
        if (campaignsTab) campaignsTab.classList.remove('hidden');
        if (templatesTab) templatesTab.classList.remove('hidden');
        if (contactsTab) contactsTab.classList.remove('hidden');
    } else {
        loggedOut.classList.remove('hidden');
        loggedIn.classList.add('hidden');
        authRequired.classList.remove('hidden');
        
        if (userInfo) {
            userInfo.textContent = '';
        }
        
        // Hide tabs that require auth
        const dashboardTab = document.getElementById('dashboard-tab');
        const campaignsTab = document.getElementById('campaigns-tab');
        const templatesTab = document.getElementById('templates-tab');
        const contactsTab = document.getElementById('contacts-tab');
        
        if (dashboardTab) dashboardTab.classList.add('hidden');
        if (campaignsTab) campaignsTab.classList.add('hidden');
        if (templatesTab) templatesTab.classList.add('hidden');
        if (contactsTab) contactsTab.classList.add('hidden');
    }
}

// Setup Event Listeners
function setupEventListeners() {
    // Check if elements exist before adding listeners
    if (elements.loginBtn) {
        console.log("Adding event listener to login button");
        elements.loginBtn.addEventListener('click', function(e) {
            console.log("Login button clicked");
            e.preventDefault();
            initiateOAuth();
        });
    } else {
        console.warn("Login button not found in DOM");
    }
    
    if (elements.logoutBtn) {
        elements.logoutBtn.addEventListener('click', logout);
    }
    
    // Tab navigation
    if (elements.tabLinks && elements.tabLinks.length > 0) {
        elements.tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('data-target');
                switchTab(targetId);
            });
        });
    } else {
        console.warn("Tab links not found in DOM");
    }
    
    // Handle direct navigation with URL hash
    window.addEventListener('hashchange', function() {
        const hash = window.location.hash.replace('#', '');
        if (hash && ['dashboard', 'campaigns', 'templates', 'contacts', 'settings'].includes(hash)) {
            switchTab(hash);
        }
    });
    
    // Settings save buttons
    if (elements.saveOAuthBtn) {
        console.log("Adding event listener to saveOAuthBtn");
        elements.saveOAuthBtn.addEventListener('click', function() {
            console.log("Save OAuth Settings button clicked");
            saveOAuthSettings();
        });
    } else {
        console.warn("Save OAuth Settings button not found in DOM");
    }
    
    if (elements.saveAppSettingsBtn) {
        elements.saveAppSettingsBtn.addEventListener('click', saveAppSettings);
    }
    
    // Campaign modal
    if (elements.newCampaignBtn) {
        elements.newCampaignBtn.addEventListener('click', () => openModal('campaign'));
    }
    
    if (elements.campaignForm) {
        elements.campaignForm.addEventListener('submit', handleCampaignSubmit);
    }
    
    // Template modal
    if (elements.newTemplateBtn) {
        elements.newTemplateBtn.addEventListener('click', () => openModal('template'));
    }
    
    if (elements.templateForm) {
        elements.templateForm.addEventListener('submit', handleTemplateSubmit);
    }
    
    // Contact modal
    if (elements.newContactBtn) {
        elements.newContactBtn.addEventListener('click', () => openModal('contact'));
    }
    
    if (elements.contactForm) {
        elements.contactForm.addEventListener('submit', handleContactSubmit);
    }
    
    // Close modals
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('[id$="-modal"]').forEach(modal => {
                modal.classList.add('hidden');
            });
        });
    });
    
    // Add Excel import listeners
    addExcelImportListeners();
}

// Excel Import Event Listeners
function addExcelImportListeners() {
    const importExcelBtn = document.getElementById('import-excel-btn');
    if (importExcelBtn) {
        importExcelBtn.addEventListener('click', () => {
            const fileInput = document.getElementById('excel-file');
            if (fileInput.files.length > 0) {
                importExcelContacts(fileInput.files[0]);
            } else {
                alert('Please select an Excel file');
            }
        });
    }
    
    const sendImportedCampaignBtn = document.getElementById('send-imported-campaign-btn');
    if (sendImportedCampaignBtn) {
        sendImportedCampaignBtn.addEventListener('click', sendImportedCampaign);
    }
    
    // Character counter for message
    const importedCampaignMessage = document.getElementById('imported-campaign-message');
    const importedMessageCharCount = document.getElementById('imported-message-char-count');
    if (importedCampaignMessage && importedMessageCharCount) {
        importedCampaignMessage.addEventListener('input', () => {
            importedMessageCharCount.textContent = importedCampaignMessage.value.length;
        });
    }
}

// Switch between tabs
function switchTab(targetId) {
    console.log("Switching to tab:", targetId);
    
    // Get elements directly if not in the elements object
    const tabLinks = elements.tabLinks || document.querySelectorAll('.tab-link');
    const tabPanes = elements.tabPanes || document.querySelectorAll('.tab-pane');
    
    if (!tabLinks || !tabPanes) {
        console.error("Tab elements not found");
        return;
    }
    
    // Update tab links
    tabLinks.forEach(link => {
        const linkTarget = link.getAttribute('data-target');
        const div = link.querySelector('div');
        
        if (!div) {
            console.warn("Tab link div not found for", linkTarget);
            return;
        }
        
        if (linkTarget === targetId) {
            div.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            div.classList.add('border-blue-500', 'text-blue-600');
            link.classList.add('active-tab');
        } else {
            div.classList.remove('border-blue-500', 'text-blue-600');
            div.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            link.classList.remove('active-tab');
        }
    });
    
    // Show selected tab
    tabPanes.forEach(pane => {
        if (pane.id === `${targetId}-tab`) {
            pane.classList.remove('hidden');
        } else {
            pane.classList.add('hidden');
        }
    });
    
    // Update URL hash to allow for direct navigation
    window.location.hash = targetId;
}

// Save OAuth Settings - MODIFIED to remove client_secret handling
function saveOAuthSettings() {
    console.log("saveOAuthSettings called");
    
    // Get element references directly if not already in elements
    const clientIdInput = elements.clientIdInput || document.getElementById('client-id');
    const redirectUriInput = elements.redirectUriInput || document.getElementById('redirect-uri');
    
    if (!clientIdInput || !redirectUriInput) {
        console.error("Could not find one or more OAuth form inputs:", {
            clientIdInput: !!clientIdInput,
            redirectUriInput: !!redirectUriInput
        });
        alert("Error: Could not find all required form inputs. Please refresh the page and try again.");
        return;
    }
    
    // Get values from the form
    const clientId = clientIdInput.value.trim();
    const redirectUri = redirectUriInput.value.trim();
    
    console.log("Form values retrieved:", {
        clientId: clientId ? "✓" : "❌",
        redirectUri: redirectUri ? "✓" : "❌"
    });
    
    // Update config object
    config.clientId = clientId;
    config.redirectUri = redirectUri;
    
    // Save to localStorage - REMOVED client_secret for security
    localStorage.setItem('podium_client_id', clientId);
    localStorage.setItem('podium_redirect_uri', redirectUri);
    
    console.log("OAuth settings saved to localStorage");
    
    // Show confirmation to user
    alert('OAuth settings saved successfully!');
    
    // Update the login button's disabled state
    const loginBtn = elements.loginBtn || document.getElementById('login-btn');
    if (loginBtn) {
        loginBtn.disabled = !(clientId && redirectUri);
    }
}

// Save App Settings
function saveAppSettings() {
    const refreshIntervalSelect = elements.refreshIntervalSelect || document.getElementById('refresh-interval');
    if (!refreshIntervalSelect) {
        console.error("Could not find refresh-interval select");
        return;
    }
    
    config.refreshInterval = parseInt(refreshIntervalSelect.value, 10);
    localStorage.setItem('podium_refresh_interval', config.refreshInterval);
    
    // Clear any existing interval and set a new one if needed
    if (window.refreshIntervalId) {
        clearInterval(window.refreshIntervalId);
        window.refreshIntervalId = null;
    }
    
    if (config.refreshInterval > 0) {
        window.refreshIntervalId = setInterval(refreshData, config.refreshInterval);
    }
    
    alert('Application settings saved!');
}

// Open modal dialogs
function openModal(type) {
    const modal = document.getElementById(`${type}-modal`);
    if (!modal) {
        console.error(`Modal not found: ${type}-modal`);
        return;
    }
    
    modal.classList.remove('hidden');
    
    // Reset form
    const form = document.getElementById(`${type}-form`);
    if (form) {
        form.reset();
    }
    
    // Load any necessary data (like locations dropdown)
    if (type === 'campaign' || type === 'template' || type === 'contact') {
        loadLocations(type);
    }
}

// Load locations for dropdowns
function loadLocations(formType) {
    console.log(`Loading locations for ${formType}...`);
    // This makes an API request to get locations
    apiRequest('/v4/locations', 'GET')
        .then(response => {
            console.log('Locations loaded:', response);
            const locations = response.data;
            const select = document.getElementById(`${formType}-locations`);
            
            // Clear existing options
            if (!select) {
                console.error(`Could not find locations select for ${formType}`);
                return;
            }
            
            select.innerHTML = '';
            
            // Add options for each location
            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = location.uid;
                option.textContent = location.name || location.displayName;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading locations:', error);
            alert('Failed to load locations. Please try again.');
        });
}

// API Request Helper
async function apiRequest(endpoint, method = 'GET', body = null) {
    console.log(`Making API request: ${method} ${endpoint}`);
    
    try {
        // Check if token is expired
        if (auth.expiresAt && new Date(auth.expiresAt) <= new Date()) {
            console.log("Token expired, attempting to refresh...");
            // Token is expired, try to refresh
            if (auth.refreshToken) {
                await refreshAccessToken();
            } else {
                throw new Error('Session expired. Please log in again.');
            }
        }
        
        // Make the request
        const options = {
            method: method,
            headers: {
                'Authorization': `Bearer ${auth.accessToken}`,
                'Content-Type': 'application/json'
            }
        };
        
        if (body) {
            options.body = JSON.stringify(body);
        }
        
        console.log(`Request options:`, options);
        const response = await fetch(`${config.apiBase}${endpoint}`, options);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error(`API error (${response.status}):`, errorText);
            
            let errorData;
            try {
                errorData = JSON.parse(errorText);
            } catch (e) {
                errorData = { message: errorText || `HTTP error ${response.status}` };
            }
            
            throw new Error(errorData.message || 'API request failed');
        }
        
        const data = await response.json();
        console.log(`API response:`, data);
        return data;
    } catch (error) {
        console.error('API Request Error:', error);
        
        // Handle authentication errors
        if (error.message.includes('authentication') || 
            error.message.includes('token') || 
            error.message.includes('unauthorized') ||
            error.message.includes('expired')) {
            alert('Your session has expired. Please log in again.');
            logout();
        }
        
        throw error;
    }
}

// Load Initial Data
function loadInitialData() {
    console.log("Loading initial data...");
    // Load dashboard data
    loadDashboardData();
    
    // Load data for other tabs
    loadCampaigns();
    loadTemplates();
    loadContacts();
}

// Refresh Data
function refreshData() {
    if (auth.accessToken) {
        loadInitialData();
    }
}

// Handle campaign form submission
function handleCampaignSubmit(e) {
    e.preventDefault();
    
    const campaignForm = elements.campaignForm || document.getElementById('campaign-form');
    if (!campaignForm) {
        console.error("Campaign form not found");
        return;
    }
    
    const formData = new FormData(campaignForm);
    const campaignLocations = document.getElementById('campaign-locations');
    
    if (!campaignLocations) {
        console.error("Campaign locations select not found");
        return;
    }
    
    // Create request payload
    const campaign = {
        name: formData.get('name'),
        message: formData.get('message'),
        locations: Array.from(campaignLocations.selectedOptions).map(opt => opt.value),
        includeActiveConversations: formData.get('includeActiveConversations') === 'on',
        recentlySentSubscriberOverride: formData.get('recentlySentSubscriberOverride') === 'on',
        status: 'ACTIVE'
    };
    
    // Submit to API
    apiRequest('/v4/campaigns', 'POST', campaign)
        .then(response => {
            document.getElementById('campaign-modal').classList.add('hidden');
            loadCampaigns();
            alert('Campaign created successfully!');
        })
        .catch(error => {
            console.error('Error creating campaign:', error);
            alert('Failed to create campaign. Please try again.');
        });
}

// Handle template form submission
function handleTemplateSubmit(e) {
    e.preventDefault();
    
    const templateForm = elements.templateForm || document.getElementById('template-form');
    if (!templateForm) {
        console.error("Template form not found");
        return;
    }
    
    const formData = new FormData(templateForm);
    const templateLocations = document.getElementById('template-locations');
    
    // Create request payload
    const template = {
        title: formData.get('title'),
        text: formData.get('text'),
        accessLevel: formData.get('accessLevel'),
        type: 'custom',
        nonDeletable: false
    };
    
    // Add location UIDs if access level is location
    if (template.accessLevel === 'location' && templateLocations) {
        template.locationUids = Array.from(templateLocations.selectedOptions).map(opt => opt.value);
    }
    
    // Submit to API
    apiRequest('/v4/templates', 'POST', template)
        .then(response => {
            const modal = document.getElementById('template-modal');
            if (modal) modal.classList.add('hidden');
            loadTemplates();
            alert('Template created successfully!');
        })
        .catch(error => {
            console.error('Error creating template:', error);
            alert('Failed to create template. Please try again.');
        });
}

// Handle contact form submission
function handleContactSubmit(e) {
    e.preventDefault();
    
    const contactForm = elements.contactForm || document.getElementById('contact-form');
    if (!contactForm) {
        console.error("Contact form not found");
        return;
    }
    
    const formData = new FormData(contactForm);
    const contactLocations = document.getElementById('contact-locations');
    
    if (!contactLocations) {
        console.error("Contact locations select not found");
        return;
    }
    
    // Create request payload
    const contact = {
        name: formData.get('name'),
        phoneNumber: formData.get('phoneNumber'),
        email: formData.get('email'),
        locations: Array.from(contactLocations.selectedOptions).map(opt => opt.value)
    };
    
    // Submit to API
    apiRequest('/v4/contacts', 'POST', contact)
        .then(response => {
            const modal = document.getElementById('contact-modal');
            if (modal) modal.classList.add('hidden');
            loadContacts();
            alert('Contact created successfully!');
        })
        .catch(error => {
            console.error('Error creating contact:', error);
            alert('Failed to create contact. Please try again.');
        });
}

// OAuth Flow
function initiateOAuth() {
    console.log("Starting OAuth flow...");
    console.log("Client ID:", config.clientId);
    console.log("Redirect URI:", config.redirectUri);
    
    if (!config.clientId || !config.redirectUri) {
        alert('Please configure OAuth settings first.');
        switchTab('settings');
        return;
    }
    
    const scope = "read_locations write_campaigns read_campaigns write_templates read_templates write_contacts read_contacts write_messages read_messages";
    const authUrl = `${config.apiBase}/oauth/authorize` +
      `?response_type=code` +
      `&client_id=${config.clientId}` +
      `&redirect_uri=${encodeURIComponent(config.redirectUri)}` +
      `&scope=${encodeURIComponent(scope)}` +
      `&state=podium_auth`;
    
    console.log("Redirecting to:", authUrl);
    try {
        console.log("Attempting to redirect...");
        setTimeout(function() {
          window.location.replace(authUrl);
        }, 500);
      } catch (e) {
        console.error("Redirect error:", e);
        alert("Redirect failed: " + e.message);
        
        // Try alternative method
        console.log("Trying alternative method...");
        window.open(authUrl, "_self");
      }
}

// Exchange code for token - This is the correct, secure implementation
function exchangeCodeForToken(code) {
    console.log("Sending code to Netlify function…");
  
    fetch('https://podiumdev.netlify.app/.netlify/functions/exchange', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        code: code,
        redirect_uri: config.redirectUri          // required so Podium matches it
      })
    })
    .then(res => res.json())
    .then(data => {
      console.log("Token exchange response:", data);
  
      if (data.access_token) {
        const expiresIn  = data.expires_in || 36000;
        const expiresAt  = new Date(Date.now() + expiresIn * 1000).toISOString();
  
        auth = {
          accessToken: data.access_token,
          refreshToken: data.refresh_token,
          expiresAt
        };
  
        localStorage.setItem('podium_access_token',  auth.accessToken);
        localStorage.setItem('podium_refresh_token', auth.refreshToken);
        localStorage.setItem('podium_expires_at',    auth.expiresAt);
  
        updateAuthUI(true);
        loadInitialData();
        switchTab('dashboard');
      } else {
        console.error('Failed to exchange code for token:', data);
        alert('Authentication failed. Please try again.');
        updateAuthUI(false);
      }
    })
    .catch(err => {
      console.error('Error during token exchange:', err);
      alert('Authentication failed. Please try again.');
      updateAuthUI(false);
    });
}

// Refresh Access Token - MODIFIED to use Netlify function instead of direct token endpoint
function refreshAccessToken() {
    console.log("Refreshing access token...");
    
    // Use the Netlify function to refresh token instead of direct access
    fetch('https://podiumdev.netlify.app/.netlify/functions/refresh', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            refresh_token: auth.refreshToken
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.access_token) {
            // Calculate expiry (default to 10 hours from now if not provided)
            const expiresIn = data.expires_in || 36000;
            const expiresAt = new Date(new Date().getTime() + expiresIn * 1000).toISOString();
            
            // Store tokens
            auth = {
                accessToken: data.access_token,
                refreshToken: data.refresh_token || auth.refreshToken,
                expiresAt: expiresAt
            };
            
            localStorage.setItem('podium_access_token', auth.accessToken);
            localStorage.setItem('podium_refresh_token', auth.refreshToken);
            localStorage.setItem('podium_expires_at', auth.expiresAt);
            
            console.log("Token refresh successful, updating UI...");
            updateAuthUI(true);
            loadInitialData();
            switchTab('dashboard');
        } else {
            console.error('Failed to refresh token:', data);
            alert('Your session has expired. Please log in again.');
            updateAuthUI(false);
        }
    })
    .catch(error => {
        console.error('Error during token refresh:', error);
        alert('Your session has expired. Please log in again.');
        updateAuthUI(false);
    });
}

// Logout
function logout() {
    console.log("Logging out...");
    // Clear auth data
    auth = {
        accessToken: null,
        refreshToken: null,
        expiresAt: null
    };
    
    localStorage.removeItem('podium_access_token');
    localStorage.removeItem('podium_refresh_token');
    localStorage.removeItem('podium_expires_at');
    
    updateAuthUI(false);
    switchTab('settings');
}

// Load Dashboard Data
function loadDashboardData() {
    // Load active campaigns count
    apiRequest('/v4/campaigns?status=ACTIVE')
        .then(response => {
            const countElement = document.getElementById('active-campaigns-count');
            if (countElement) countElement.textContent = response.data.length;
            
            const lastUpdatedElement = document.getElementById('last-updated-campaigns');
            if (lastUpdatedElement) lastUpdatedElement.textContent = new Date().toLocaleTimeString();
        })
        .catch(error => {
            console.error('Error loading active campaigns:', error);
        });
    
    // Note: These endpoints might not exist exactly as shown
    // You would need to adapt to what's available in the Podium API
    
    // Load recent activity
    apiRequest('/v4/campaign_interactions?limit=10')
        .then(response => {
            const activityTableBody = document.getElementById('activity-table-body');
            if (!activityTableBody) {
                console.error("Activity table body not found");
                return;
            }
            
            activityTableBody.innerHTML = '';
            
            if (response.data.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="3" class="px-6 py-4 text-center text-gray-500">
                        No recent activity found
                    </td>
                `;
                activityTableBody.appendChild(tr);
                return;
            }
            
            response.data.forEach(interaction => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${new Date(interaction.createdAt).toLocaleString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${formatInteractionType(interaction.interactionType)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${interaction.campaign ? `Campaign: ${interaction.campaign.uid.substring(0, 8)}...` : 'N/A'}
                    </td>
                `;
                activityTableBody.appendChild(tr);
            });
        })
        .catch(error => {
            console.error('Error loading recent activity:', error);
        });
}

// Load Campaigns
function loadCampaigns() {
    apiRequest('/v4/campaigns')
        .then(response => {
            const campaignsTableBody = document.getElementById('campaigns-table-body');
            if (!campaignsTableBody) {
                console.error("Campaigns table body not found");
                return;
            }
            
            campaignsTableBody.innerHTML = '';
            
            if (response.data.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                        No campaigns found
                    </td>
                `;
                campaignsTableBody.appendChild(tr);
                return;
            }
            
            response.data.forEach(campaign => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${escapeHtml(campaign.name)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusClass(campaign.status)}">
                            ${campaign.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${formatDate(campaign.createdAt)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${campaign.locations ? campaign.locations.length : 0} locations
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <button class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                        <button class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `;
                campaignsTableBody.appendChild(tr);
            });
        })
        .catch(error => {
            console.error('Error loading campaigns:', error);
        });
}

// Load Templates
function loadTemplates() {
    apiRequest('/v4/templates')
        .then(response => {
            const templatesTableBody = document.getElementById('templates-table-body');
            if (!templatesTableBody) {
                console.error("Templates table body not found");
                return;
            }
            
            templatesTableBody.innerHTML = '';
            
            if (response.data.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                        No templates found
                    </td>
                `;
                templatesTableBody.appendChild(tr);
                return;
            }
            
            response.data.forEach(template => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${escapeHtml(template.title)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${template.type}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${formatDate(template.createdAt)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${template.lastUsedAt ? formatDate(template.lastUsedAt) : 'Never'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <button class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                        <button class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `;
                templatesTableBody.appendChild(tr);
            });
        })
        .catch(error => {
            console.error('Error loading templates:', error);
        });
}

// Load Contacts
function loadContacts() {
    apiRequest('/v4/contacts?limit=20')
        .then(response => {
            const contactsTableBody = document.getElementById('contacts-table-body');
            if (!contactsTableBody) {
                console.error("Contacts table body not found");
                return;
            }
            
            contactsTableBody.innerHTML = '';
            
            if (response.data.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                        No contacts found
                    </td>
                `;
                contactsTableBody.appendChild(tr);
                return;
            }
            
            response.data.forEach(contact => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${escapeHtml(contact.name)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${contact.phoneNumbers && contact.phoneNumbers.length ? contact.phoneNumbers[0] : 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${contact.emails && contact.emails.length ? contact.emails[0] : 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${contact.tags && contact.tags.length ? contact.tags.map(tag => `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${escapeHtml(tag.label)}</span>`).join(' ') : 'No tags'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <button class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                        <button class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `;
                contactsTableBody.appendChild(tr);
            });
        })
        .catch(error => {
            console.error('Error loading contacts:', error);
        });
}

// Helper Functions
function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString();
}

function getStatusClass(status) {
    switch (status) {
        case 'ACTIVE':
            return 'bg-green-100 text-green-800';
        case 'DRAFT':
            return 'bg-yellow-100 text-yellow-800';
        case 'COMPLETED':
            return 'bg-blue-100 text-blue-800';
        case 'STOPPED':
        case 'ERROR':
            return 'bg-red-100 text-red-800';
        default:
            return 'bg-gray-100 text-gray-800';
    }
}

function formatInteractionType(type) {
    switch (type) {
        case 'sent':
            return 'Message Sent';
        case 'response':
            return 'Response Received';
        case 'feedback_left':
            return 'Feedback Left';
        case 'review_left':
            return 'Review Left';
        default:
            return type.replace('_', ' ').charAt(0).toUpperCase() + type.slice(1);
    }
}

// Ensure all DOM elements are loaded before initializing
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM fully loaded, initializing application");
    
    // Initialize DOM elements before calling init
    initializeElements();
    
    // Initialize the application
    init();
    
    // Add debug button for development
    const settingsTab = document.getElementById('settings-tab');
    if (settingsTab) {
        const debugDiv = document.createElement('div');
        debugDiv.className = 'bg-white rounded-lg shadow-md p-6 mt-6';
        debugDiv.innerHTML = `
            <h3 class="text-lg font-bold mb-4">Debug Tools</h3>
            <button id="debug-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                Debug Settings
            </button>
            <button id="clear-storage-btn" class="ml-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                Clear Storage
            </button>
            <div id="debug-output" class="mt-4 p-4 bg-gray-100 rounded text-sm font-mono hidden"></div>
        `;
        settingsTab.appendChild(debugDiv);
        
        // Add event listeners for debug buttons
        document.getElementById('debug-btn')?.addEventListener('click', function() {
            const output = document.getElementById('debug-output');
            if (output) {
                output.classList.remove('hidden');
                output.innerHTML = `
                    <p>Client ID: ${localStorage.getItem('podium_client_id') || 'Not set'}</p>
                    <p>Redirect URI: ${localStorage.getItem('podium_redirect_uri') || 'Not set'}</p>
                    <p>Access Token: ${localStorage.getItem('podium_access_token') ? '******' : 'Not set'}</p>
                    <p>Refresh Token: ${localStorage.getItem('podium_refresh_token') ? '******' : 'Not set'}</p>
                    <p>Expires At: ${localStorage.getItem('podium_expires_at') || 'Not set'}</p>
                `;
            }
        });
        
        document.getElementById('clear-storage-btn')?.addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all stored OAuth settings?')) {
                localStorage.removeItem('podium_client_id');
                localStorage.removeItem('podium_redirect_uri');
                localStorage.removeItem('podium_access_token');
                localStorage.removeItem('podium_refresh_token');
                localStorage.removeItem('podium_expires_at');
                alert('All OAuth settings cleared. Page will refresh.');
                window.location.reload();
            }
        });
    }
});