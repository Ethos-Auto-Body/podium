<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>E.A.B Developer Portal</title>
  <!-- Tailwind & Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
  <style>
    :root {
      --netlify-primary: #00ad9f;
      --netlify-primary-dark: #008e83;
      --netlify-secondary: #2d3748;
      --netlify-sidebar: #1a202c;
      --netlify-sidebar-hover: #2d3748;
      --netlify-text: #f7fafc;
      --netlify-border: #e2e8f0;
      --netlify-focus: rgba(0, 173, 159, 0.5);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
                   Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    /* Transitions */
    .transition-all { transition: all .2s ease-in-out; }
    .transition-height { transition: max-height .3s ease-in-out; overflow: hidden; }

    /* Navigation */
    .nav-item {
      border-left: 4px solid transparent;
      transition: all .2s ease;
    }
    .nav-item-active {
      border-left-color: var(--netlify-primary);
      background-color: var(--netlify-sidebar-hover);
      color: #fff;
    }
    .nav-item:hover:not(.nav-item-active) {
      background-color: var(--netlify-sidebar-hover);
      border-left-color: rgba(0,173,159,0.5);
    }

    /* Tooltip */
    .tooltip { position: relative; display: inline-block; }
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: var(--netlify-secondary);
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity .3s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 10;
    }
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

    /* Loader */
    .loader {
      border: 4px solid #e2e8f0;
      border-top-color: var(--netlify-primary);
      border-radius: 50%;
      width: 2.5rem; height: 2.5rem;
      animation: spinner 1.5s linear infinite;
    }
    @keyframes spinner {
      to { transform: rotate(360deg); }
    }

    /* Toast */
    .toast {
      position: fixed; top: 1.25rem; right: 1.25rem;
      padding: 1rem; border-radius: .25rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateX(120%); transition: transform .3s ease-out;
      z-index: 9999;
    }
    .toast-show { transform: translateX(0); }
    .toast-success { background: var(--netlify-primary); color: #fff; }
    .toast-error   { background: #F56565; color: #fff; }

    /* Forms & Buttons */
    .form-input {
      border: 1px solid #cbd5e0; border-radius: .375rem;
      padding: .5rem .75rem;
      transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
    }
    .form-input:focus {
      outline: none; border-color: var(--netlify-primary);
      box-shadow: 0 0 0 3px var(--netlify-focus);
    }
    .btn-primary {
      background: var(--netlify-primary); color: #fff;
      padding: .5rem 1rem; border-radius: .375rem;
      transition: background .2s ease;
    }
    .btn-primary:hover {
      background: var(--netlify-primary-dark);
    }
    .btn-secondary {
      background: #fff; color: #4a5568;
      border: 1px solid #e2e8f0; padding: .5rem 1rem;
      border-radius: .375rem; transition: background .2s ease, border-color .2s ease;
    }
    .btn-secondary:hover {
      background: #f7fafc; border-color: #cbd5e0;
    }

    /* Checkbox */
    .custom-checkbox {
      appearance: none; -webkit-appearance: none;
      width: 1.125rem; height: 1.125rem;
      border: 2px solid #cbd5e0; border-radius: .25rem;
      position: relative; cursor: pointer;
      transition: all .2s ease;
    }
    .custom-checkbox:checked {
      background: var(--netlify-primary); border-color: var(--netlify-primary);
    }
    .custom-checkbox:checked::after {
      content: "";
      position: absolute; left: 4px; top: 2px;
      width: 6px; height: 10px;
      border: solid #fff; border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    /* Cards & Badges */
    .netlify-card {
      background: #fff; border-radius: .5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      transition: box-shadow .3s ease, transform .3s ease;
    }
    .netlify-card:hover {
      box-shadow: 0 10px 15px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    .netlify-badge {
      display: inline-flex; align-items: center;
      padding: .25rem .75rem; border-radius: 9999px;
      font-size: .75rem; font-weight: 500;
      background: rgba(0,173,159,0.1); color: var(--netlify-primary);
      margin: .25rem .5rem .25rem 0;
    }
    .netlify-badge button {
      margin-left: .25rem; background: none; border: none;
      font-weight: 700; cursor: pointer; color: var(--netlify-primary);
    }
  </style>
</head>

<body class="flex flex-col h-screen overflow-hidden bg-gray-100">
  <!-- Toast -->
  <div id="toast" class="toast"><i id="toast-icon" class="mr-2"></i><span id="toast-message"></span></div>

  <!-- Header -->
  <header class="bg-white shadow-sm z-10">
    <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16 items-center">
        <div class="flex items-center space-x-2">
          <div class="h-10 w-10 rounded-md flex items-center justify-center text-white text-2xl font-bold"
               style="background: var(--netlify-primary);">E</div>
          <span class="text-2xl font-bold text-gray-800">E.A.B<span class="font-normal text-gray-600">Developer</span></span>
        </div>
        <nav class="flex items-center space-x-4">
          <a href="#" class="text-gray-600 hover:text-gray-900 px-3 py-2 text-sm font-medium transition-all">Marketplace</a>
          <a href="#" class="text-gray-600 hover:text-gray-900 px-3 py-2 text-sm font-medium transition-all">API Reference</a>
          <a href="#" class="text-gray-600 hover:text-gray-900 px-3 py-2 text-sm font-medium transition-all">Guides</a>
          <button id="logoutBtn" class="btn-secondary px-4 py-2 text-sm font-medium">Logout</button>
        </nav>
      </div>
    </div>
  </header>

  <div class="flex-1 flex overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-64 bg-[var(--netlify-sidebar)] overflow-y-auto">
      <div class="p-6">
        <h2 class="text-lg font-semibold text-white">My Application</h2>
      </div>
      <nav class="space-y-1 px-3">
        <a href="#" class="nav-link nav-item group flex items-center px-3 py-3 text-sm font-medium rounded-md text-gray-300 hover:text-white"
           data-target="basic-info">
          <i class="fas fa-info-circle mr-3 text-gray-400 group-hover:text-white"></i>Basic Info
        </a>
        <a href="#" class="nav-link nav-item nav-item-active group flex items-center px-3 py-3 text-sm font-medium rounded-md text-white"
           data-target="oauth">
          <i class="fas fa-key mr-3 text-white"></i>OAuth
        </a>
        <a href="#" class="nav-link nav-item group flex items-center px-3 py-3 text-sm font-medium rounded-md text-gray-300 hover:text-white"
           data-target="webhooks">
          <i class="fas fa-plug mr-3 text-gray-400 group-hover:text-white"></i>Webhooks
        </a>
        <a href="#" class="nav-link nav-item group flex items-center px-3 py-3 text-sm font-medium rounded-md text-gray-300 hover:text-white"
           data-target="api-explorer">
          <i class="fas fa-search mr-3 text-gray-400 group-hover:text-white"></i>API Explorer
        </a>
        <a href="#" class="nav-link nav-item group flex items-center px-3 py-3 text-sm font-medium rounded-md text-gray-300 hover:text-white"
           data-target="documentation">
          <i class="fas fa-book mr-3 text-gray-400 group-hover:text-white"></i>Documentation
        </a>
      </nav>
    </aside>

    <!-- Main content -->
    <main class="flex-1 relative overflow-y-auto bg-gray-100 p-8">
      <!-- Basic Info Panel -->
      <section id="basic-info-panel" class="content-panel hidden">
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-2xl font-semibold text-gray-900">Basic Information</h1>
          <div class="flex space-x-3">
            <button class="cancel-btn btn-secondary px-4 py-2 text-sm font-medium">Cancel</button>
            <button class="save-btn btn-primary px-4 py-2 text-sm font-medium">Save</button>
          </div>
        </div>
        <div class="netlify-card overflow-hidden">
          <div class="px-6 py-6">
            <div class="grid gap-6">
              <div>
                <label for="app-name" class="block text-sm font-medium text-gray-700 mb-1">Application Name</label>
                <input type="text" id="app-name" class="form-input w-full" placeholder="My Integration"/>
              </div>
              <div>
                <label for="app-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea id="app-description" rows="3" class="form-input w-full" placeholder="Describe what your application does"></textarea>
              </div>
              <div>
                <label for="website-url" class="block text-sm font-medium text-gray-700 mb-1">Website URL</label>
                <input type="url" id="website-url" class="form-input w-full" placeholder="https://example.com"/>
              </div>
              <div>
                <label for="privacy-url" class="block text-sm font-medium text-gray-700 mb-1">Privacy Policy URL</label>
                <input type="url" id="privacy-url" class="form-input w-full" placeholder="https://example.com/privacy"/>
              </div>
              <div>
                <label for="support-email" class="block text-sm font-medium text-gray-700 mb-1">Support Email</label>
                <input type="email" id="support-email" class="form-input w-full" placeholder="support@example.com"/>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- OAuth Panel -->
      <section id="oauth-panel" class="content-panel">
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-2xl font-semibold text-gray-900">OAuth</h1>
          <div class="flex space-x-3">
            <button class="cancel-btn btn-secondary px-4 py-2 text-sm font-medium">Cancel</button>
            <button id="oauth-save-btn" class="save-btn btn-primary px-4 py-2 text-sm font-medium">Save</button>
          </div>
        </div>
        <div class="netlify-card overflow-hidden">
          <div class="px-6 py-6">
            <div class="grid gap-6">
              <!-- App Icon -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">App Icon</label>
                <div class="mt-1 flex items-center">
                  <div class="h-32 w-32 border-2 border-dashed rounded-md flex items-center justify-center text-gray-400
                              cursor-pointer transition-all hover:border-teal-500 hover:text-teal-500"
                       style="border-color: var(--netlify-border);">
                    <i class="fas fa-plus fa-2x"></i>
                  </div>
                </div>
              </div>

              <!-- Client ID -->
              <div>
                <label for="client-id" class="block text-sm font-medium text-gray-700 mb-1">Client ID</label>
                <div class="relative flex mt-1">
                  <input type="text" id="client-id" class="form-input pr-12 w-full bg-gray-50" placeholder="Will appear here"/>
                  <button id="copy-client-id" class="absolute right-0 top-0 h-full px-3 py-2 text-gray-500 hover:text-gray-700 focus:outline-none">
                    <i class="far fa-copy"></i>
                  </button>
                </div>
              </div>

              <!-- Client Secret -->
              <div>
                <div class="flex justify-between items-center mb-1">
                  <label for="client-secret" class="block text-sm font-medium text-gray-700">Client Secret</label>
                  <button id="regenerate-secret" class="text-xs" style="color: var(--netlify-primary);">Regenerate</button>
                </div>
                <div class="relative flex mt-1">
                  <input type="password" id="client-secret" class="form-input pr-12 w-full bg-gray-50" placeholder="Will appear here"/>
                  <button id="toggle-secret" class="absolute right-0 top-0 h-full px-3 py-2 text-gray-500 hover:text-gray-700 focus:outline-none">
                    <i class="far fa-eye"></i>
                  </button>
                </div>
                <p class="mt-1 text-sm text-gray-500">Never share your client secret.</p>
              </div>

              <!-- Redirect URI -->
              <div>
                <label for="redirect-uri" class="block text-sm font-medium text-gray-700 mb-1">Redirect URI</label>
                <input type="url" id="redirect-uri" class="form-input w-full" placeholder="https://example.com/callback"/>
                <p class="mt-1 text-sm text-gray-500">Where users will be redirected after authentication</p>
              </div>

              <!-- Scopes -->
              <div>
                <label for="scopes" class="block text-sm font-medium text-gray-700 mb-1">Scopes</label>
                <div class="relative mt-1">
                  <button id="select-scopes-btn" class="inline-flex justify-between w-full px-4 py-2 text-sm font-medium text-gray-700 bg-white
                                                    border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none transition-all">
                    <span>Select Scopes</span><i class="fas fa-chevron-down ml-2"></i>
                  </button>
                  <div id="scopes-dropdown"
                       class="hidden absolute z-10 mt-1 w-full bg-white shadow-lg rounded-md py-1 text-sm ring-1 ring-black ring-opacity-5
                              overflow-auto max-h-60">
                    <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Read</div>
                    <div class="space-y-0.5 px-2">
                      <label class="flex items-center px-2 py-1 hover:bg-gray-100 cursor-pointer">
                        <input type="checkbox" class="scope-checkbox custom-checkbox mr-2" value="read_locations"/>read_locations
                      </label>
                      <label class="flex items-center px-2 py-1 hover:bg-gray-100 cursor-pointer">
                        <input type="checkbox" class="scope-checkbox custom-checkbox mr-2" value="read_organizations"/>read_organizations
                      </label>
                      <label class="flex items-center px-2 py-1 hover:bg-gray-100 cursor-pointer">
                        <input type="checkbox" class="scope-checkbox custom-checkbox mr-2" value="read_campaigns"/>read_campaigns
                      </label>
                      <label class="flex items-center px-2 py-1 hover:bg-gray-100 cursor-pointer">
                        <input type="checkbox" class="scope-checkbox custom-checkbox mr-2" value="read_contacts"/>read_contacts
                      </label>
                      <label class="flex items-center px-2 py-1 hover:bg-gray-100 cursor-pointer">
                        <input type="checkbox" class="scope-checkbox custom-checkbox mr-2" value="read_templates"/>read_templates
                      </label>
                      <label class="flex items-center px-2 py-1 hover:bg-gray-100 cursor-pointer">
                        <input type="checkbox" class="scope-checkbox custom-checkbox mr-2" value="read_messages"/>read_messages
                      </label>
                      <label class="flex items-center px-2 py-1 hover:bg-gray-100 cursor-pointer">
                        <input type="checkbox" class="scope-checkbox custom-checkbox mr-2" value="read_reviews"/>read_reviews
                      </label>
                      <label class="flex items-center px-2 py-1 hover:bg-gray-100 cursor-pointer">
                        <input type="checkbox" class="scope-checkbox custom-checkbox mr-2" value="read_payments"/>read_payments
                      </label>
                    </div>
                    <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Write</div>
                    <div class="space-y-0.5 px-2">
                      <label class="flex items-center px-2 py-1 hover:bg-gray-100 cursor-pointer">
                        <input type="checkbox" class="scope-checkbox custom-checkbox mr-2" value="write_campaigns"/>write_campaigns
                      </label>
                      <label class="flex items-center px-2 py-1 hover:bg-gray-100 cursor-pointer">
                        <input type="checkbox" class="scope-checkbox custom-checkbox mr-2" value="write_contacts"/>write_contacts
                      </label>
                      <label class="flex items-center px-2 py-1 hover:bg-gray-100 cursor-pointer">
                        <input type="checkbox" class="scope-checkbox custom-checkbox mr-2" value="write_templates"/>write_templates
                      </label>
                      <label class="flex items-center px-2 py-1 hover:bg-gray-100 cursor-pointer">
                        <input type="checkbox" class="scope-checkbox custom-checkbox mr-2" value="write_messages"/>write_messages
                      </label>
                      <label class="flex items-center px-2 py-1 hover:bg-gray-100 cursor-pointer">
                        <input type="checkbox" class="scope-checkbox custom-checkbox mr-2" value="write_reviews"/>write_reviews
                      </label>
                      <label class="flex items-center px-2 py-1 hover:bg-gray-100 cursor-pointer">
                        <input type="checkbox" class="scope-checkbox custom-checkbox mr-2" value="write_payments"/>write_payments
                      </label>
                    </div>
                  </div>
                </div>
                <div id="selected-scopes" class="mt-3 flex flex-wrap gap-2"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Resources -->
        <div class="mt-6 netlify-card overflow-hidden">
          <div class="px-6 py-6">
            <h3 class="flex items-center text-lg font-medium text-gray-900 mb-4">
              <i class="fas fa-book-open mr-2" style="color: var(--netlify-primary)"></i>Resources
            </h3>
            <p class="text-sm text-gray-600">OAuth 2.0 provides a secure way to access the E.A.B API.</p>
            <div class="mt-3 space-y-2">
              <a href="#" class="block text-base hover:underline" style="color: var(--netlify-primary)">OAuth 2.0 Overview</a>
              <a href="#" class="block text-base hover:underline" style="color: var(--netlify-primary)">OAuth Scopes</a>
              <a href="#" class="block text-base hover:underline" style="color: var(--netlify-primary)">Implementation Guide</a>
            </div>
          </div>
        </div>
      </section>

      <!-- Webhooks Panel -->
      <section id="webhooks-panel" class="content-panel hidden">
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-2xl font-semibold text-gray-900">Webhooks</h1>
          <button id="add-webhook-btn" class="btn-primary px-4 py-2 text-sm font-medium">Add Webhook</button>
        </div>
        <div id="webhooks-container" class="netlify-card overflow-hidden p-6 text-center text-gray-500">
          <i class="fas fa-plug fa-2x mb-4 text-gray-400"></i>
          <h3 class="text-base font-medium text-gray-900 mb-1">No webhooks</h3>
          <p class="text-sm mb-4">Create a new webhook to receive real-time events.</p>
          <button id="empty-add-webhook-btn" class="btn-primary inline-flex items-center px-5 py-2 text-sm font-medium">
            <i class="fas fa-plus mr-2"></i>Add Webhook
          </button>
        </div>
      </section>

      <!-- API Explorer Panel -->
      <section id="api-explorer-panel" class="content-panel hidden">
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-2xl font-semibold text-gray-900">API Explorer</h1>
        </div>
        <div class="netlify-card overflow-hidden px-6 py-6">
          <div class="grid gap-6">
            <div>
              <label for="endpoint-select" class="block text-sm font-medium text-gray-700 mb-1">Endpoint</label>
              <select id="endpoint-select" class="form-input mt-1 block w-full">
                <option value="">Select an endpoint</option>
                <optgroup label="Locations">
                  <option>GET /v4/locations</option>
                  <option>GET /v4/locations/{uid}</option>
                  <option>PATCH /v4/locations/{uid}</option>
                </optgroup>
                <optgroup label="Campaigns">
                  <option>GET /v4/campaigns</option>
                  <option>POST /v4/campaigns</option>
                  <option>GET /v4/campaigns/{uid}</option>
                </optgroup>
                <optgroup label="Contacts">
                  <option>GET /v4/contacts</option>
                  <option>POST /v4/contacts</option>
                  <option>GET /v4/contacts/{uid}</option>
                </optgroup>
              </select>
            </div>
            <div>
              <label for="api-params" class="block text-sm font-medium text-gray-700 mb-1">Parameters</label>
              <textarea id="api-params" rows="5"
                        class="form-input w-full font-mono"
                        placeholder='{
  "name": "Example Campaign",
  "message": "Hello, this is a test!",
  "locations": ["location-uid"],
  "status": "ACTIVE"
}'></textarea>
            </div>
            <button id="send-request-btn" class="btn-primary inline-flex items-center px-4 py-2 text-sm font-medium">
              Send Request
            </button>
            <div>
              <label for="api-response" class="block text-sm font-medium text-gray-700 mb-1">Response</label>
              <div class="mt-1 bg-gray-50 rounded-md border border-gray-200">
                <pre id="api-response" class="p-4 font-mono text-sm overflow-auto max-h-80">// Response will appear here</pre>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Documentation Panel -->
      <section id="documentation-panel" class="content-panel hidden">
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-2xl font-semibold text-gray-900">Documentation</h1>
        </div>
        <div class="grid gap-6 md:grid-cols-2">
          <div class="netlify-card p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-3">Getting Started</h3>
            <p class="text-gray-600 mb-4">Learn how to integrate with the E.A.B API</p>
            <a href="#" class="flex items-center font-medium hover:underline" style="color: var(--netlify-primary)">
              Read Guide <i class="fas fa-arrow-right ml-2"></i>
            </a>
          </div>
          <div class="netlify-card p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-3">Authentication</h3>
            <p class="text-gray-600 mb-4">Understand OAuth 2.0 and API authentication</p>
            <a href="#" class="flex items-center font-medium hover:underline" style="color: var(--netlify-primary)">
              Read Guide <i class="fas fa-arrow-right ml-2"></i>
            </a>
          </div>
          <div class="netlify-card p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-3">API Reference</h3>
            <p class="text-gray-600 mb-4">Complete reference for all endpoints</p>
            <a href="#" class="flex items-center font-medium hover:underline" style="color: var(--netlify-primary)">
              View Reference <i class="fas fa-arrow-right ml-2"></i>
            </a>
          </div>
          <div class="netlify-card p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-3">Webhooks</h3>
            <p class="text-gray-600 mb-4">Learn how to use webhooks for real-time updates</p>
            <a href="#" class="flex items-center font-medium hover:underline" style="color: var(--netlify-primary)">
              Read Guide <i class="fas fa-arrow-right ml-2"></i>
            </a>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Persistence iframe for private browsing -->
  <iframe id="persistence-frame" class="absolute opacity-0 pointer-events-none"></iframe>

  <script>
  (function() {
    // LocalStorage fallback
    try {
      localStorage.setItem('test','x'); localStorage.removeItem('test');
    } catch {
      const iframe = document.getElementById('persistence-frame');
      iframe.contentWindow.document.open();
      iframe.contentWindow.document.write('<script>var storage = {};<\/script>');
      iframe.contentWindow.document.close();
      window.localStorage = {
        setItem(k,v) { iframe.contentWindow.storage[k]=v; },
        getItem(k)  { return iframe.contentWindow.storage[k]||null; },
        removeItem(k){ delete iframe.contentWindow.storage[k]; },
        clear()     { iframe.contentWindow.storage = {}; }
      };
    }

    // ======== HELPERS ========

// Save key/value to localStorage with a `eab_` prefix
function saveState(key, value) {
  try {
    localStorage.setItem('eab_' + key, JSON.stringify(value));
  } catch (e) {
    console.error('Save error:', e);
  }
}

// Load key from localStorage and parse JSON
function loadState(key) {
  try {
    const val = localStorage.getItem('eab_' + key);
    return val ? JSON.parse(val) : null;
  } catch (e) {
    console.error('Load error:', e);
    return null;
  }
}

// Generate a random string ID
function generateId() {
  return Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
}

// Validate a URL string
function isValidUrl(str) {
  try {
    new URL(str);
    return true;
  } catch {
    return false;
  }
}

// Show a toast notification
function showToast(message, type = "success") {
  const toast = document.getElementById('toast');
  const toastIcon = document.getElementById('toast-icon');
  const toastMessage = document.getElementById('toast-message');

  toast.className = 'toast toast-show';

  if (type === 'success') {
    toast.classList.add('toast-success');
    toastIcon.className = 'fas fa-check-circle mr-2';
  } else {
    toast.classList.add('toast-error');
    toastIcon.className = 'fas fa-exclamation-circle mr-2';
  }

  toastMessage.textContent = message;

  setTimeout(() => {
    toast.classList.remove('toast-show');
  }, 3000);
}

// ======== DOM READY ========

document.addEventListener('DOMContentLoaded', () => {
  const navLinks = document.querySelectorAll('.nav-link');
  const panels = document.querySelectorAll('.content-panel');

  // Sidebar navigation logic
  navLinks.forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      const target = link.dataset.target;

      navLinks.forEach(l => l.classList.remove('nav-item-active', 'text-white'));
      panels.forEach(p => p.classList.add('hidden'));

      link.classList.add('nav-item-active', 'text-white');
      document.getElementById(`${target}-panel`).classList.remove('hidden');
      saveState('activePanel', target);
    });
  });

  // Load last open tab
  const active = loadState('activePanel');
  if (active) {
    const link = document.querySelector(`.nav-link[data-target="${active}"]`);
    if (link) link.click();
  } else {
    const defaultLink = document.querySelector('.nav-link[data-target="oauth"]');
    if (defaultLink) defaultLink.click();
  }

  // ‚úÖ Listen for OAuth callback messages from popup window
  window.addEventListener("message", (event) => {
  // ‚úÖ Listen for OAuth callback messages from popup window
  window.addEventListener("message", (event) => {
    if (event.data?.type === "OAUTH_CALLBACK") {
      console.log("‚úÖ OAuth Code:", event.data.code);
      console.log("üîê OAuth State:", event.data.state);

      const clientId = loadState("clientId");
      const clientSecret = loadState("clientSecret");
      const redirectUri = loadState("redirectUri");

      fetch("https://api.podium.com/oauth/token", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          client_id: clientId,
          client_secret: clientSecret,
          redirect_uri: redirectUri,
          grant_type: "authorization_code",
          code: event.data.code,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          localStorage.setItem("eab_accessToken", data.access_token);
          localStorage.setItem("eab_refreshToken", data.refresh_token);
          localStorage.setItem("eab_tokenExpiry", Date.now() + data.expires_in * 1000);

          const tokenPreview = data.access_token.slice(-6);
          const oauthPanel = document.getElementById("oauth-panel");
          const notice = document.createElement("div");

          notice.className = "mt-6 p-4 bg-green-100 text-green-800 rounded-md shadow-sm text-center text-sm";
          notice.innerHTML = `
            <strong>‚úÖ Connected to Podium</strong><br>
            <span class="block mt-1">Access Token ending in: <code>${tokenPreview}</code></span>
            <a href="#" class="mt-3 inline-block text-sm font-medium text-teal-600 hover:underline" data-target="api-explorer">
              ‚û°Ô∏è Explore the API
            </a>
          `;

          oauthPanel.appendChild(notice);

          const oauthLink = document.querySelector(`.nav-link[data-target="oauth"]`);
          if (oauthLink) oauthLink.click();

          showToast("Authenticated! Ready to access API.", "success");
        })
        .catch((err) => {
          showToast("OAuth failed: " + err.message, "error");
        });
    }
  });

    if (event.data?.type === "OAUTH_CALLBACK") {
      console.log("‚úÖ OAuth Code:", event.data.code);
      console.log("üîê OAuth State:", event.data.state);

      const clientId = loadState("clientId");
      const clientSecret = loadState("clientSecret");
      const redirectUri = loadState("redirectUri");

      fetch("https://api.podium.com/oauth/token", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          client_id: clientId,
          client_secret: clientSecret,
          redirect_uri: redirectUri,
          grant_type: "authorization_code",
          code: event.data.code,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          localStorage.setItem("eab_accessToken", data.access_token);
          localStorage.setItem("eab_refreshToken", data.refresh_token);
          localStorage.setItem("eab_tokenExpiry", Date.now() + data.expires_in * 1000);
          showToast("Authenticated via popup!", "success");

          // Optional: Show Estimate tab or refresh part of UI
          const oauthLink = document.querySelector(`.nav-link[data-target="oauth"]`);
          if (oauthLink) oauthLink.click();
        })
        .catch((err) => {
          showToast("Popup OAuth error: " + err.message, "error");
        });
    }
  });
});


    document.addEventListener('DOMContentLoaded', ()=> {
      const navLinks = document.querySelectorAll('.nav-link'),
            panels   = document.querySelectorAll('.content-panel');

      // Navigation
      navLinks.forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          const target = link.dataset.target;
          navLinks.forEach(l => l.classList.remove('nav-item-active','text-white'));
          panels.forEach(p => p.classList.add('hidden'));
          link.classList.add('nav-item-active','text-white');
          document.getElementById(target+'-panel').classList.remove('hidden');
          saveState('activePanel', target);
        });
      });

      // Restore panel or default to OAuth
      const active = loadState('activePanel');
      if (active) {
        document.querySelector(`.nav-link[data-target="${active}"]`).click();
      } else {
        document.querySelector(`.nav-link[data-target="oauth"]`).click();
      }

      // Scopes dropdown
      const scopesBtn = document.getElementById('select-scopes-btn'),
            dropdown  = document.getElementById('scopes-dropdown'),
            checkboxes= document.querySelectorAll('.scope-checkbox'),
            selContainer = document.getElementById('selected-scopes');

      scopesBtn.addEventListener('click', ()=> dropdown.classList.toggle('hidden'));
      document.addEventListener('click', e => {
        if (!scopesBtn.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.add('hidden');
        }
      });
      function updateSelectedScopes() {
        selContainer.innerHTML = '';
        const picked = [];
        checkboxes.forEach(cb => {
          if (cb.checked) {
            picked.push(cb.value);
            const badge = document.createElement('div');
            badge.className = 'netlify-badge';
            badge.innerHTML = `${cb.value} <button data-scope="${cb.value}">&times;</button>`;
            selContainer.appendChild(badge);
          }
        });
        saveState('selectedScopes', picked);
        selContainer.querySelectorAll('button').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const sc = btn.dataset.scope;
            checkboxes.forEach(cb=>{ if(cb.value===sc) cb.checked=false; });
            updateSelectedScopes();
          });
        });
      }
      checkboxes.forEach(cb => cb.addEventListener('change', updateSelectedScopes));
      const savedScopes = loadState('selectedScopes');
      if (savedScopes) {
        checkboxes.forEach(cb => { if (savedScopes.includes(cb.value)) cb.checked = true; });
        updateSelectedScopes();
      }

      // Toggle secret visibility
      document.getElementById('toggle-secret').addEventListener('click', ()=>{
        const inp = document.getElementById('client-secret'),
              btn = document.getElementById('toggle-secret'),
              type = inp.type==='password'?'text':'password';
        inp.type = type;
        btn.innerHTML = type==='password'?'<i class="far fa-eye"></i>':'<i class="far fa-eye-slash"></i>';
      });

      // Copy Client ID
      document.getElementById('copy-client-id').addEventListener('click', ()=>{
        const inp = document.getElementById('client-id');
        inp.select(); document.execCommand('copy');
        showToast('Client ID copied!', 'success');
      });

      // Regenerate secret
      document.getElementById('regenerate-secret').addEventListener('click', ()=>{
        const newSec = generateId()+generateId();
        document.getElementById('client-secret').value = newSec;
        saveState('clientSecret', newSec);
        showToast('Client Secret regenerated!', 'success');
      });

      // OAuth Save
      document.getElementById('oauth-save-btn').addEventListener('click', ()=>{
        const uriInput = document.getElementById('redirect-uri');
        const uri = uriInput.value.trim();
        if (!uri) return showToast('Redirect URI is required', 'error');
        if (!isValidUrl(uri)) return showToast('Please enter a valid URL', 'error');
        saveState('redirectUri', uri);

        let clientId = loadState('clientId');
        if (!clientId) {
          clientId = generateId();
          saveState('clientId', clientId);
          document.getElementById('client-id').value = clientId;
        }
        let clientSecret = loadState('clientSecret');
        if (!clientSecret) {
          clientSecret = generateId()+generateId();
          saveState('clientSecret', clientSecret);
          document.getElementById('client-secret').value = clientSecret;
        }

        const scopes = (loadState('selectedScopes')||[]).join('%20');
        const state = generateId();
        saveState('oauthState', state);

        const authUrl = `https://api.podium.com/oauth/authorize?client_id=${clientId}`
          +`&redirect_uri=${encodeURIComponent(uri)}&scope=${scopes}&state=${state}`;
        window.open(authUrl, '_blank');
        showToast('OAuth flow initiated!', 'success');
      });

      // Load saved OAuth fields
      const sc = loadState('selectedScopes')||[];
      const cid = loadState('clientId'), csec = loadState('clientSecret'), ruri = loadState('redirectUri');
      if (cid) document.getElementById('client-id').value = cid;
      if (csec) document.getElementById('client-secret').value = csec;
      if (ruri) document.getElementById('redirect-uri').value = ruri;

      // Logout
      document.getElementById('logoutBtn').addEventListener('click', ()=>{
        if (confirm('Are you sure you want to log out?')) {
          ['accessToken','refreshToken','tokenExpiry'].forEach(k=>localStorage.removeItem('eab_'+k));
          showToast('Logged out!', 'success');
        }
      });

      // Cancel buttons
      document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.addEventListener('click', ()=>{
          const savedCid = loadState('clientId'),
                savedCsec= loadState('clientSecret'),
                savedUri = loadState('redirectUri');
          if (savedCid) document.getElementById('client-id').value = savedCid;
          if (savedCsec) document.getElementById('client-secret').value = savedCsec;
          if (savedUri) document.getElementById('redirect-uri').value = savedUri;
          showToast('Changes discarded', 'success');
        });
      });

      // Webhooks: display form, fetch/list, create, edit, delete
      const webhooksPanel = document.getElementById('webhooks-panel'),
            whContainer  = document.getElementById('webhooks-container'),
            addBtn       = document.getElementById('add-webhook-btn'),
            emptyAddBtn  = document.getElementById('empty-add-webhook-btn');

      function showWebhooksPlaceholder() {
        whContainer.innerHTML = `
          <div class="text-center py-10">
            <i class="fas fa-plug fa-2x text-gray-400 mb-4"></i>
            <h3 class="text-base font-medium text-gray-900">No webhooks</h3>
            <p class="text-sm text-gray-500 mb-6">Create a new webhook to receive real-time events.</p>
            <button id="empty-add-webhook-btn" class="btn-primary inline-flex items-center px-5 py-2 text-sm font-medium">
              <i class="fas fa-plus mr-2"></i>Add Webhook
            </button>
          </div>`;
        document.getElementById('empty-add-webhook-btn')
                .addEventListener('click', displayWebhookForm);
      }

      function displayWebhookForm(webhook) {
        const isEdit = !!webhook;
        whContainer.innerHTML = `
          <div class="mb-6 flex justify-between items-center">
            <h1 class="text-2xl font-semibold text-gray-900">${isEdit?'Edit':'Add'} Webhook</h1>
            <div class="space-x-2">
              <button id="webhook-cancel-btn" class="btn-secondary px-4 py-2 text-sm font-medium">Cancel</button>
              <button id="webhook-save-btn" class="btn-primary px-4 py-2 text-sm font-medium">${isEdit?'Update':'Save'}</button>
            </div>
          </div>
          <div class="netlify-card overflow-hidden">
            <div class="px-6 py-6 grid gap-6">
              <div>
                <label for="webhook-url" class="block text-sm font-medium text-gray-700 mb-1">Webhook URL</label>
                <input type="url" id="webhook-url" class="form-input w-full" placeholder="https://your-server.com/webhook" value="${webhook?.url||''}"/>
                <p class="mt-1 text-sm text-gray-500">Where Podium will send event notifications</p>
              </div>
              <div>
                <label for="webhook-secret" class="block text-sm font-medium text-gray-700 mb-1">Secret Key</label>
                <input type="text" id="webhook-secret" class="form-input w-full" placeholder="Your secret key" value="${webhook?.secret||''}"/>
                <p class="mt-1 text-sm text-gray-500">Used to verify webhook requests</p>
              </div>
              <div class="flex items-center mb-4">
                <label class="inline-flex items-center">
                  <input type="checkbox" id="webhook-status" class="custom-checkbox mr-2"${webhook?.disabled?'':' checked'}/>
                  <span>${webhook?.disabled?'Disabled':'Active'}</span>
                </label>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Event Types</label>
                <div class="space-y-2">
                  <div class="border border-gray-200 rounded-md p-4">
                    <h4 class="font-medium mb-2">Contact Events</h4>
                    <div class="grid grid-cols-2 gap-2">
                      ${['contact.created','contact.updated','contact.deleted']
                        .map(evt=>`
                          <label class="flex items-center">
                            <input type="checkbox" class="custom-checkbox mr-2" value="${evt}"
                              ${(webhook?.eventTypes?.includes(evt)?'checked':'')}/>
                            <span>${evt}</span>
                          </label>`).join('')}
                    </div>
                  </div>
                  <div class="border border-gray-200 rounded-md p-4">
                    <h4 class="font-medium mb-2">Message Events</h4>
                    <div class="grid grid-cols-2 gap-2">
                      ${['message.sent','message.received','message.failed']
                        .map(evt=>`
                          <label class="flex items-center">
                            <input type="checkbox" class="custom-checkbox mr-2" value="${evt}"
                              ${(webhook?.eventTypes?.includes(evt)?'checked':'')}/>
                            <span>${evt}</span>
                          </label>`).join('')}
                    </div>
                  </div>
                  <div class="border border-gray-200 rounded-md p-4">
                    <h4 class="font-medium mb-2">Invoice Events</h4>
                    <div class="grid grid-cols-2 gap-2">
                      ${['invoice.created','invoice.payment_created']
                        .map(evt=>`
                          <label class="flex items-center">
                            <input type="checkbox" class="custom-checkbox mr-2" value="${evt}"
                              ${(webhook?.eventTypes?.includes(evt)?'checked':'')}/>
                            <span>${evt}</span>
                          </label>`).join('')}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>`;
        document.getElementById('webhook-cancel-btn').addEventListener('click', loadWebhooks);
        document.getElementById('webhook-save-btn').addEventListener('click', ()=> {
          isEdit ? updateWebhook(webhook.uid) : saveWebhook();
        });
      }

      function loadWebhooks() {
        const token = localStorage.getItem('eab_accessToken');
        if (!token) return showToast('Please authenticate first', 'error');
        whContainer.innerHTML = `
          <div class="flex justify-center py-10"><div class="loader"></div></div>`;
        fetch('https://api.podium.com/v4/webhooks', {
          headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(r=> {
          if (!r.ok) throw new Error(r.status);
          return r.json();
        })
        .then(json=>{
          const list = json.data||[];
          if (!list.length) {
            showWebhooksPlaceholder();
            return;
          }
          let html = `
            <table class="min-w-full divide-y divide-gray-200">
              <thead>
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">URL</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Events</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                ${list.map(w=>`
                  <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${w.url}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      ${w.eventTypes.slice(0,2).join(', ')}
                      ${w.eventTypes.length>2?`+${w.eventTypes.length-2} more`:''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                        ${w.disabled?'bg-red-100 text-red-800':'bg-green-100 text-green-800'}">
                        ${w.disabled?'Disabled':'Active'}
                      </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                      <button class="edit-webhook text-teal-600 hover:text-teal-900 mr-3" data-uid="${w.uid}">Edit</button>
                      <button class="delete-webhook text-red-600 hover:text-red-900" data-uid="${w.uid}">Delete</button>
                    </td>
                  </tr>`).join('')}
              </tbody>
            </table>`;
          whContainer.innerHTML = html;
          document.getElementById('add-webhook-btn')
                  .addEventListener('click', ()=> displayWebhookForm());
          document.querySelectorAll('.edit-webhook').forEach(btn=>{
            btn.addEventListener('click', ()=> {
              const uid = btn.dataset.uid;
              fetch(`https://api.podium.com/v4/webhooks/${uid}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              })
              .then(r=> r.json())
              .then(j=> displayWebhookForm(j.data))
              .catch(e=> showToast('Error loading webhook', 'error'));
            });
          });
          document.querySelectorAll('.delete-webhook').forEach(btn=>{
            btn.addEventListener('click', ()=>{
              const uid = btn.dataset.uid;
              if (!confirm('Delete this webhook?')) return;
              fetch(`https://api.podium.com/v4/webhooks/${uid}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
              })
              .then(r=> {
                if (!r.ok) throw new Error(r.status);
                showToast('Deleted!', 'success');
                loadWebhooks();
              })
              .catch(e=> showToast('Failed to delete', 'error'));
            });
          });
        })
        .catch(err=>{
          whContainer.innerHTML = `
            <div class="text-center py-10">
              <i class="fas fa-exclamation-circle fa-2x text-red-500 mb-4"></i>
              <h3 class="text-base font-medium text-gray-900">Error loading webhooks</h3>
              <p class="text-sm text-gray-500">${err.message}</p>
            </div>`;
        });
      }

      function saveWebhook() {
        const token = localStorage.getItem('eab_accessToken');
        if (!token) return showToast('Authenticate first', 'error');
        const url = document.getElementById('webhook-url').value.trim(),
              secret = document.getElementById('webhook-secret').value.trim(),
              eventTypes = Array.from(webhooksPanel.querySelectorAll('input.custom-checkbox'))
                                 .filter(cb=>cb.checked)
                                 .map(cb=>cb.value);
        if (!url) return showToast('URL is required', 'error');
        if (!eventTypes.length) return showToast('Select at least one event', 'error');
        const btn = document.getElementById('webhook-save-btn');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
        fetch('https://api.podium.com/v4/webhooks', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ url, secret, eventTypes })
        })
        .then(r=> {
          if (!r.ok) throw new Error(r.status);
          return r.json();
        })
        .then(()=> {
          showToast('Created!', 'success');
          loadWebhooks();
        })
        .catch(err=>{
          showToast('Failed: '+err.message, 'error');
          btn.disabled = false; btn.textContent = 'Save';
        });
      }

      function updateWebhook(uid) {
        const token = localStorage.getItem('eab_accessToken');
        if (!token) return showToast('Authenticate first', 'error');
        const url      = document.getElementById('webhook-url').value.trim(),
              secret   = document.getElementById('webhook-secret').value.trim(),
              disabled = !document.getElementById('webhook-status').checked,
              eventTypes = Array.from(webhooksPanel.querySelectorAll('input.custom-checkbox'))
                                 .filter(cb=>cb.checked)
                                 .map(cb=>cb.value);
        if (!url) return showToast('URL is required', 'error');
        if (!eventTypes.length) return showToast('Select events', 'error');
        const btn = document.getElementById('webhook-save-btn');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';
        fetch(`https://api.podium.com/v4/webhooks/${uid}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ url, secret, disabled, eventTypes })
        })
        .then(r=> {
          if (!r.ok) throw new Error(r.status);
          return r.json();
        })
        .then(()=>{
          showToast('Updated!', 'success');
          loadWebhooks();
        })
        .catch(err=>{
          showToast('Failed: '+err.message, 'error');
          btn.disabled = false; btn.textContent = 'Update';
        });
      }

      // API Explorer
      document.getElementById('send-request-btn').addEventListener('click', ()=>{
        const token = localStorage.getItem('eab_accessToken');
        if (!token) return showToast('Authenticate first', 'error');
        const sel     = document.getElementById('endpoint-select').value.trim();
        const params  = document.getElementById('api-params').value.trim();
        const respEl  = document.getElementById('api-response');
        if (!sel) return showToast('Select endpoint', 'error');
        const [method, path] = sel.split(' ');
        respEl.textContent = 'Loading...';
        let options = {
          method,
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        };
        if (['POST','PUT','PATCH'].includes(method) && params) {
          try {
            options.body = JSON.stringify(JSON.parse(params));
          } catch {
            showToast('Invalid JSON', 'error');
            respEl.textContent = 'Error: Invalid JSON';
            return;
          }
        }
        fetch(`https://api.podium.com${path}`, options)
          .then(r=> {
            const ct = r.headers.get('content-type')||'';
            return ct.includes('application/json') ? r.json() : r.text();
          })
          .then(data=>{
            respEl.textContent = typeof data==='object' ? JSON.stringify(data,null,2) : data;
          })
          .catch(err=>{
            respEl.textContent = `Error: ${err.message}`;
          });
      });

      // Check for OAuth callback
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code'), state = urlParams.get('state');
      if (code && state) {
        const savedState = loadState('oauthState');
        if (state === savedState) {
          const clientId = loadState('clientId'),
                clientSecret = loadState('clientSecret'),
                redirectUri  = loadState('redirectUri');
          fetch('https://api.podium.com/oauth/token', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
              client_id: clientId,
              client_secret: clientSecret,
              redirect_uri: redirectUri,
              grant_type: 'authorization_code',
              code
            })
          })
          .then(r=>r.json())
          .then(data=>{
            localStorage.setItem('eab_accessToken', data.access_token);
            localStorage.setItem('eab_refreshToken', data.refresh_token);
            localStorage.setItem('eab_tokenExpiry', Date.now() + data.expires_in*1000);
            showToast('Authenticated!', 'success');
            window.history.replaceState({}, document.title, window.location.pathname);
          })
          .catch(err=>{
            showToast('Auth failed: '+err.message,'error');
          });
        } else {
          showToast('Invalid state parameter','error');
        }
      }

      // Token refresh every minute
      setInterval(()=>{
        const expiry = localStorage.getItem('eab_tokenExpiry'),
              refresh = localStorage.getItem('eab_refreshToken');
        if (expiry && refresh && (expiry - Date.now() < 300_000)) {
          const clientId = loadState('clientId'),
                clientSecret = loadState('clientSecret');
          fetch('https://api.podium.com/oauth/token', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
              client_id: clientId,
              client_secret: clientSecret,
              grant_type: 'refresh_token',
              refresh_token: refresh
            })
          })
          .then(r=>r.json())
          .then(data=>{
            localStorage.setItem('eab_accessToken', data.access_token);
            localStorage.setItem('eab_refreshToken', data.refresh_token);
            localStorage.setItem('eab_tokenExpiry', Date.now()+data.expires_in*1000);
          })
          .catch(e=> console.error('Token refresh failed',e));
        }
      }, 60_000);

      // Subtle button hover animation
      document.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('mouseenter', ()=> btn.style.transform='translateY(-1px)');
        btn.addEventListener('mouseleave', ()=> btn.style.transform='translateY(0)');
      });
    });
  })();
  </script>
</body>
</html>
